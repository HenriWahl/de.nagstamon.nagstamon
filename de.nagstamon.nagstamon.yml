app-id: de.nagstamon.nagstamon
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
#sdk-extensions:
#  - org.freedesktop.Sdk.Extension.rust-stable
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.10'
command: nagstamon
rename-appdata-file: nagstamon.appdata.xml
rename-desktop-file: nagstamon.desktop
rename-icon: nagstamon
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --device=dri
  - --persist=.nagstamon
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.kde.StatusNotifierWatcher
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  - --filesystem=xdg-run/keyring
  - --filesystem=home
cleanup-commands:
  - /app/cleanup-BaseApp.sh
modules:
  # from submodule https://github.com/flathub/shared-modules.git
  #- shared-modules/libsecret/libsecret.json

  - name: krb5
    subdir: src
    config-opts:
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-static
      - --disable-rpath
    cleanup:
      - /bin
      - /share/et
      - /share/examples
      - /share/man
    sources:
      - type: archive
        url: https://github.com/krb5/krb5/archive/refs/tags/krb5-1.22.1-final.tar.gz
        sha256: d7dd1ded54c1c2d3381da4a266935feda6ba6398155720df27e2975bd5a39239
      - type: shell
        dest: src
        commands:
          - autoreconf -si

  - name: dbus-run-session
    #buildsystem: autotools
    buildsystem: meson
    cleanup: ['*']
    sources:
      - type: archive
        #url: https://gitlab.freedesktop.org/dbus/dbus/-/archive/dbus-1.14.10/dbus-dbus-1.14.10.tar.gz
        url: https://gitlab.freedesktop.org/dbus/dbus/-/archive/dbus-1.16.2/dbus-dbus-1.16.2.tar.gz
        #sha256: 5fedcd6c17fbc62646af224e1aab11a334c463e7e7d89163a670ed24e7ab241c
        sha256: d77cc71acd93e85f2bd2a6fe3a40e5bd023519e3e9fa9b5361e7109f42b74060
        x-checker-data:
          type: anitya
          project-id: 5356
          url-template: https://gitlab.freedesktop.org/dbus/dbus/-/archive/dbus-$version/dbus-dbus-$version.tar.gz
    config-opts:
      - -Dsystemd=disabled

  - name: dbus-python
    buildsystem: autotools
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.4.0.tar.xz
        sha256: c36b28f10ffcc8f1f798aca973bcc132f91f33eb9b6b8904381b4077766043d5
        x-checker-data:
          type: anitya
          project-id: 402
          url-template: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-$version.tar.xz

  # external python modules
  - python-modules.yml

  - name: nagstamon
    buildsystem: simple
    build-commands:
      - python3 setup.py bdist --format tar
      - tar -xvf dist/nagstamon*.tar --strip 2 -C /app
      - install -Dm755 nagstamon.sh /app/bin/nagstamon
      - mkdir -p /app/share/icons/hicolor/scalable/apps/      -
      - install -Dm644 /app/share/pixmaps/nagstamon.svg -t /app/share/icons/hicolor/scalable/apps/
      - install -Dm644 nagstamon.appdata.xml -t /app/share/metainfo
    sources:
      - type: archive
        url: https://github.com/HenriWahl/Nagstamon/archive/refs/tags/v3.16.2.tar.gz
        sha256: 42e5ecd26b98d02bc424507b7a1321bdc406e0c072a77c92126afba81d5e9c49
      - type: file
        url: https://raw.githubusercontent.com/HenriWahl/Nagstamon/master/Nagstamon/resources/nagstamon.appdata.xml
        sha256: fe5143576c1d201b81f7d9a4effc319ccff6b6f551e2b549607c3500caf0b48b
      - type: file
        path: nagstamon.sh
